<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Creating a Character Controller with C++ (Part Two)" /><meta property="og:locale" content="en" /><meta name="description" content="After planning the character controller, it was time to implement it. The implementation so far has been very involved, so I will only cover the high-level points required to get to a minimally viable character controller." /><meta property="og:description" content="After planning the character controller, it was time to implement it. The implementation so far has been very involved, so I will only cover the high-level points required to get to a minimally viable character controller." /><link rel="canonical" href="https://brooke.fyi/posts/cpp-character-controller-2/" /><meta property="og:url" content="https://brooke.fyi/posts/cpp-character-controller-2/" /><meta property="og:site_name" content="Brooke Rhodes" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-04-18T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Creating a Character Controller with C++ (Part Two)" /><meta name="twitter:site" content="@grilme99" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-04-18T00:00:00+01:00","datePublished":"2023-04-18T00:00:00+01:00","description":"After planning the character controller, it was time to implement it. The implementation so far has been very involved, so I will only cover the high-level points required to get to a minimally viable character controller.","headline":"Creating a Character Controller with C++ (Part Two)","mainEntityOfPage":{"@type":"WebPage","@id":"https://brooke.fyi/posts/cpp-character-controller-2/"},"url":"https://brooke.fyi/posts/cpp-character-controller-2/"}</script><title>Creating a Character Controller with C++ (Part Two) | Brooke Rhodes</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Brooke Rhodes"><meta name="application-name" content="Brooke Rhodes"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/img/avatar.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">Brooke Rhodes</a></div><div class="site-subtitle fst-italic">Software Engineer working on games, systems, and tools.</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/grilme99" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/grilme99" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['brooke','gril.me'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Creating a Character Controller with C++ (Part Two)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>Creating a Character Controller with C++ (Part Two)</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1681772400" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 18, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://brooke.sh">Brooke Rhodes</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1822 words" > <em>10 min</em> read</span></div></div></div><div class="post-content"><p>After planning the character controller, it was time to implement it. The implementation so far has been very involved, so I will only cover the high-level points required to get to a minimally viable character controller.</p><h2 id="architecture"><span class="me-2">Architecture</span><a href="#architecture" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To support the extensible nature of this character controller, it needs to be architectured in much of a “distributed” manner. This means there is a central <code class="language-plaintext highlighter-rouge">Simulation</code> class that manages and orchestrates any number of <code class="language-plaintext highlighter-rouge">MoveType</code>s.</p><p>This choice of architecture is highly beneficial because it leaves so much room for future expansion. All move types are entirely decoupled from one another, so they can be changed and added trivially without impacting other move types. Keeping move types in distinctly separate classes also simplifies maintenance and documentation because of the clear separation of concerns.</p><p><a href="/assets/img/post/simulation-architecture-light.png" class="popup img-link light w-75 shadow rounded-10 shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1212 668'%3E%3C/svg%3E" data-src="/assets/img/post/simulation-architecture-light.png" alt="light mode only" width="1212" height="668" class="lazyload" data-proofer-ignore></a> <a href="/assets/img/post/simulation-architecture-dark.png" class="popup img-link dark w-75 shadow rounded-10 shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1212 668'%3E%3C/svg%3E" data-src="/assets/img/post/simulation-architecture-dark.png" alt="dark mode only" width="1212" height="668" class="lazyload" data-proofer-ignore></a> <em>Visual example of this choice of architecture. Highlights the clear separation of concerns and flow of data.</em></p><h3 id="simulation-class"><span class="me-2">Simulation Class</span><a href="#simulation-class" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>At the core of the controller is the Simulation. This class orchestrates and manages the lifecycle of all <code class="language-plaintext highlighter-rouge">MoveType</code>s. It works like this:</p><ol><li>The Simulation stores most state relevant to the running of the character’s physics sim. This includes:<ul><li>Simulation constants (walk speed, run speed, jump height, etc.)<li><code class="language-plaintext highlighter-rouge">SimulationState</code>, a struct that contains the runtime state of the Simulation, such as the current <code class="language-plaintext highlighter-rouge">MoveType</code>, and the velocity and position of the character.</ul><li>The Simulation exposes several utility methods for use by move types. For example, the <code class="language-plaintext highlighter-rouge">Sweep</code> implementation is defined in the Simulation as a public method. Our Sweep method abstracts away the gritty details of Unreal Engine’s Sweep API, giving the developer a straightforward interface for performing Sweep tests in the world. Other methods, such as <code class="language-plaintext highlighter-rouge">ProjectVelocity</code>, are also defined here, which we’ll explore later.<li>The Simulation exposes methods for transitioning to a new <code class="language-plaintext highlighter-rouge">MoveType</code>. It handles cleaning up the old <code class="language-plaintext highlighter-rouge">MoveType</code> and ensuring the new one runs in the same frame (if that was specified as an option). Finally, the Simulation exposes a public method for ticking the sim forward. This method is very lightweight because it only calls the <code class="language-plaintext highlighter-rouge">Tick</code> method in the active <code class="language-plaintext highlighter-rouge">MoveType</code> and reconciles and changes.</ol><p>Most of the work in the Simulation class happens in the utility methods, which can be relatively complex. However, in concept, the Simulation class only orchestrates the <code class="language-plaintext highlighter-rouge">MoveType</code> classes.</p><h3 id="movetype-classes"><span class="me-2">MoveType Classes</span><a href="#movetype-classes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The <code class="language-plaintext highlighter-rouge">MoveType</code> classes are the backbone of our character controller and can be best thought of as state machines that define how the character can move. Each <code class="language-plaintext highlighter-rouge">MoveType</code> class is unique and encapsulates the behaviours and rules for a specific movement type, such as walking, running, jumping, or crouching. By keeping these behaviours separate, we can create a clean, maintainable codebase where each movement type can evolve independently from the others.</p><p><code class="language-plaintext highlighter-rouge">MoveType</code> classes are designed with extensibility in mind. Each class is independent and agnostic of the others, so developers can easily add new movement types or modify existing ones without worrying about unexpected side effects. For instance, if you wanted to add a new “gliding” move type, you could simply create a new MoveType subclass that encapsulates the gliding behaviour and then register it with the Simulation class. This approach makes the character controller highly flexible and adaptable to various game designs and character movements.</p><h2 id="implementing-the-physics-simulation"><span class="me-2">Implementing the Physics Simulation</span><a href="#implementing-the-physics-simulation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As already discussed in the previous blog entry, this character controller is built on the concept of <em>sweep testing</em>. Please refer to the previous entry for an explanation of what sweep testing is and how it is performed.</p><p>The <code class="language-plaintext highlighter-rouge">Simulation</code> class exposes a <code class="language-plaintext highlighter-rouge">Sweep</code> utility method that abstracts away the details of Unreal Engine’s built-in sweeping API. This utility method removes all the boilerplate required to sweep in Unreal Engine, creating a vastly simplified API for developers to consume.</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="n">FHitResult</span><span class="o">&gt;</span> <span class="n">ACharacterController</span><span class="o">::</span><span class="n">Sweep</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector</span> <span class="n">StartPosition</span><span class="p">,</span> <span class="k">const</span> <span class="n">FVector</span> <span class="n">EndPosition</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
    <span class="n">FCollisionQueryParams</span> <span class="n">Params</span> <span class="o">=</span> <span class="n">FCollisionQueryParams</span><span class="p">();</span>
    <span class="n">Params</span><span class="p">.</span><span class="n">bTraceComplex</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="n">FHitResult</span> <span class="n">SweepResult</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">Hit</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SweepSingleByChannel</span><span class="p">(</span>
        <span class="n">SweepResult</span><span class="p">,</span>
        <span class="n">StartPosition</span><span class="p">,</span>
        <span class="n">EndPosition</span><span class="p">,</span>
        <span class="n">SweepRotation</span><span class="p">,</span>
        <span class="n">ECC_PhysicsBody</span><span class="p">,</span>
        <span class="n">SweepShape</span><span class="p">,</span>
        <span class="n">Params</span>
    <span class="p">);</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">Hit</span><span class="p">,</span> <span class="n">SweepResult</span><span class="p">};</span>
<span class="p">}</span>
</pre></table></code></div></div><p>For a visual aid, here is a diagram showcasing how a Sweep works:</p><p><a href="/assets/img/post/sweep-example-light.png" class="popup img-link light w-75 shadow rounded-10 shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1212 668'%3E%3C/svg%3E" data-src="/assets/img/post/sweep-example-light.png" alt="light mode only" width="1212" height="668" class="lazyload" data-proofer-ignore></a> <a href="/assets/img/post/sweep-example-dark.png" class="popup img-link dark w-75 shadow rounded-10 shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1212 668'%3E%3C/svg%3E" data-src="/assets/img/post/sweep-example-dark.png" alt="dark mode only" width="1212" height="668" class="lazyload" data-proofer-ignore></a> <em>Demonstration of a sweep test, a simple example of moving a box throught the world until it hits a wall.</em></p><p>All other physics routines are built on top of this method. For example, we detect if the player is standing on the ground by sweeping down from a position a very tiny amount. They are considered to be grounded if the sweep hits something.</p><p><a href="/assets/img/post/ground-check-light.png" class="popup img-link light w-75 shadow rounded-10 shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1212 668'%3E%3C/svg%3E" data-src="/assets/img/post/ground-check-light.png" alt="light mode only" width="1212" height="668" class="lazyload" data-proofer-ignore></a> <a href="/assets/img/post/ground-check-dark.png" class="popup img-link dark w-75 shadow rounded-10 shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1212 668'%3E%3C/svg%3E" data-src="/assets/img/post/ground-check-dark.png" alt="dark mode only" width="1212" height="668" class="lazyload" data-proofer-ignore></a> <em>Visual example of how GoundCheck queries work.</em></p><h3 id="projectvelocity"><span class="me-2">ProjectVelocity</span><a href="#projectvelocity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Another core component of the physics routine is the <code class="language-plaintext highlighter-rouge">ProjectVelocity</code> method. The implementation of this routine is based heavily on that of Quake and <a href="https://github.com/easy-games/chickynoid">Chickynoid</a>, as discussed in the previous blog entry.</p><p><code class="language-plaintext highlighter-rouge">ProjectVelocity</code> projects the character through the world based on some velocity over a certain period of time (given by <code class="language-plaintext highlighter-rouge">DeltaTime</code>). This builds on top of sweeps by handling velocity deflections as the player moves along surfaces. <code class="language-plaintext highlighter-rouge">ProjectVelocity</code> is the magic that allows players to slide along walls!</p><p>The idea looks like this:</p><p><a href="/assets/img/post/project-vel-light.png" class="popup img-link light w-75 shadow rounded-10 shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1212 668'%3E%3C/svg%3E" data-src="/assets/img/post/project-vel-light.png" alt="light mode only" width="1212" height="668" class="lazyload" data-proofer-ignore></a> <a href="/assets/img/post/project-vel-dark.png" class="popup img-link dark w-75 shadow rounded-10 shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1212 668'%3E%3C/svg%3E" data-src="/assets/img/post/project-vel-dark.png" alt="dark mode only" width="1212" height="668" class="lazyload" data-proofer-ignore></a> <em>Demonstration of ProjectVelocity. This diagram is recreated from one the author of Chickynoid used to teach my the idea behind this technique (thank you ❤️).</em></p><p>In this diagram, the player is projected by some significant velocity value and deflected along three different walls. This behaviour of sliding along walls is achieved through a combination of sweeps and handling of the resulting collision normals.</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre><td class="rouge-code"><pre><span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="n">FVector</span><span class="p">,</span> <span class="n">FVector</span><span class="p">,</span> <span class="kt">bool</span><span class="o">&gt;</span> <span class="n">ACharacterController</span><span class="o">::</span><span class="n">ProjectVelocity</span><span class="p">(</span>
    <span class="n">FVector</span> <span class="n">StartPosition</span><span class="p">,</span>
    <span class="n">FVector</span> <span class="n">StartVelocity</span><span class="p">,</span>
    <span class="kt">float</span> <span class="n">DeltaTime</span>
<span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">FVector</span> <span class="n">MovePos</span> <span class="o">=</span> <span class="n">StartPosition</span><span class="p">;</span>
    <span class="n">FVector</span> <span class="n">MoveVel</span> <span class="o">=</span> <span class="n">StartVelocity</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">HitSomething</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="n">TSet</span><span class="o">&lt;</span><span class="n">uint32</span><span class="o">&gt;</span> <span class="n">HitObjects</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">TimeLeft</span> <span class="o">=</span> <span class="n">DeltaTime</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">MoveVel</span><span class="p">.</span><span class="n">Length</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="n">f</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span> <span class="c1">// Done</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">MoveVel</span><span class="p">.</span><span class="n">GetSafeNormal</span><span class="p">().</span><span class="n">Dot</span><span class="p">(</span><span class="n">StartVelocity</span><span class="p">.</span><span class="n">GetSafeNormal</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// We projected back in the opposite direction from where we started</span>
            <span class="n">MoveVel</span> <span class="o">=</span> <span class="n">FVector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// We only operate on a scaled down version of velocity</span>
        <span class="k">auto</span> <span class="p">[</span><span class="n">_</span><span class="p">,</span> <span class="n">Result</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sweep</span><span class="p">(</span><span class="n">MovePos</span><span class="p">,</span> <span class="n">MovePos</span> <span class="o">+</span> <span class="p">(</span><span class="n">MoveVel</span> <span class="o">*</span> <span class="n">TimeLeft</span><span class="p">));</span>

        <span class="c1">// Update our position</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Result</span><span class="p">.</span><span class="n">Time</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">MovePos</span> <span class="o">=</span> <span class="n">Result</span><span class="p">.</span><span class="n">TraceEnd</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// See if we swept the whole way</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Result</span><span class="p">.</span><span class="n">Time</span> <span class="o">==</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// We'd have broken here if we didn't hit something</span>
        <span class="n">HitSomething</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

        <span class="c1">// Hit!</span>
        <span class="n">TimeLeft</span> <span class="o">-=</span> <span class="p">(</span><span class="n">TimeLeft</span> <span class="o">*</span> <span class="n">Result</span><span class="p">.</span><span class="n">Time</span><span class="p">);</span>

        <span class="k">const</span> <span class="n">uint32</span> <span class="n">HitId</span> <span class="o">=</span> <span class="n">Result</span><span class="p">.</span><span class="n">HitObjectHandle</span><span class="p">.</span><span class="n">GetInstanceUID</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">HitObjects</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">HitId</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">HitObjects</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">HitId</span><span class="p">);</span>

            <span class="c1">// Deflect the velocity and keep going</span>
            <span class="n">MoveVel</span> <span class="o">=</span> <span class="n">FMathUtils</span><span class="o">::</span><span class="n">ClipVelocity</span><span class="p">(</span><span class="n">MoveVel</span><span class="p">,</span> <span class="n">Result</span><span class="p">.</span><span class="n">Normal</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="c1">// We hit the same object twice, push off it a bit</span>
            <span class="n">MovePos</span> <span class="o">+=</span> <span class="n">Result</span><span class="p">.</span><span class="n">Normal</span><span class="p">;</span>
            <span class="n">MoveVel</span> <span class="o">+=</span> <span class="n">Result</span><span class="p">.</span><span class="n">Normal</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">MovePos</span><span class="p">,</span> <span class="n">MoveVel</span><span class="p">,</span> <span class="n">HitSomething</span><span class="p">};</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This code looks rather complex, but here’s a deep dive into how it works:</p><p>Whenever the character moves and potentially collides with something, <code class="language-plaintext highlighter-rouge">ProjectVelocity</code> calls the <code class="language-plaintext highlighter-rouge">Sweep</code> method. This method tests the trajectory of the character from its current position to its expected position after the given time step, considering the current velocity. If a collision is detected, the <code class="language-plaintext highlighter-rouge">Sweep</code> method returns an <code class="language-plaintext highlighter-rouge">FHitResult</code> struct with a <code class="language-plaintext highlighter-rouge">Normal</code> vector. This <code class="language-plaintext highlighter-rouge">Normal</code> is a unit vector perpendicular to the surface with which the character collided.</p><p>When <code class="language-plaintext highlighter-rouge">ProjectVelocity</code> receives this <code class="language-plaintext highlighter-rouge">Normal</code>, it uses it to deflect the character’s velocity, allowing the character to “slide” along the surface instead of stopping upon collision. This is achieved by the <code class="language-plaintext highlighter-rouge">ClipVelocity</code> function, which modifies the character’s velocity based on the collision normal.</p><p>So, if the character moved directly towards a wall and collided with it, the normal would be directed away from it, causing the character to stop. But if the character collided with the wall at an angle, the normal would be somewhat sideways, causing the character’s velocity to be deflected sideways as well. This is what allows the character to slide along walls instead of stopping.</p><p>The process is repeated up to three times within a single call to <code class="language-plaintext highlighter-rouge">ProjectVelocity</code>, allowing multiple deflections. However, this choice of deflection count is not arbitrary. It is directly referenced from Quake III and is based on the geometric principle that it takes three planes intersecting to form a concavity that would fully catch and stop a ray. In other words, in the most complex case, the character would need to deflect off of three surfaces to navigate a corner. Despite this, the loop will usually exit after the first deflection.</p><p>This is how the character can quickly slide along multiple surfaces, as illustrated in the diagram. Each deflection represents a potential change in direction, allowing the character to navigate complex environments smoothly.</p><p>Keep in mind that the actual physics behind this behaviour is a bit more complex, including how the character’s speed is affected by these deflections, but this gives a general idea of how <code class="language-plaintext highlighter-rouge">ProjectVelocity</code> allows characters to slide along walls. A lot of credit goes to the Quake III and Chickynoid source codes as a reference to help implement this, as the math was rather complex.</p><h2 id="retrospective"><span class="me-2">Retrospective</span><a href="#retrospective" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><iframe class="embed-video youtube lazyload" src="https://www.youtube.com/embed/lvbAb5OCPSk" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><p>I learnt a lot throughout this project! The controller fulfilled the majority of the requirements initially laid out. As a group, we re-implemented this controller in Unity as we changed the engine part way through our group project (that’s worth a whole other blog post). Having the opportunity to do this again with C# allowed me to fix many of the mistakes I made in this C++ version, but again, that’s for another blog entry.</p><p>This controller has one big, glaring issue: it’s incompatible with Unreal Engine networking. I should have had more due diligence initially when investigating how networking would play out in this scenario. Still, I ultimately needed to use Unreal’s built-in character framework to network the character because it was simply too much work to do ourselves. If we hadn’t moved to Unity (for unrelated reasons), I would have invested the time to refactor the controller to extend off Unreal’s built-in character tools.</p><p>Despite the unfortunate problem of the controller being unable to meet our networking goal, I learnt heaps from this project. As already mentioned, this was my first time ever using C++ and Unreal Engine in any non-trivial capacity, and I got to grips with C++ incredibly quickly. I suspect this is thanks to my experience with other systems languages like <a href="https://rust-lang.org">Rust</a> and my years working in game engines like Roblox.</p><p>On the bright side, I got to re-purpose this character controller for another solo assignment – so all was not lost! The assignment I ultimately used this project for was a great fit, and being able to re-purpose it saved me a lot of time.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/university/'>University</a>, <a href='/categories/devblog/'>Devblog</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/university/" class="post-tag no-text-decoration" >university</a> <a href="/tags/c/" class="post-tag no-text-decoration" >c++</a> <a href="/tags/unreal-engine/" class="post-tag no-text-decoration" >unreal engine</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Creating%20a%20Character%20Controller%20with%20C++%20(Part%20Two)%20-%20Brooke%20Rhodes&url=https%3A%2F%2Fbrooke.fyi%2Fposts%2Fcpp-character-controller-2%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Creating%20a%20Character%20Controller%20with%20C++%20(Part%20Two)%20-%20Brooke%20Rhodes&u=https%3A%2F%2Fbrooke.fyi%2Fposts%2Fcpp-character-controller-2%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fbrooke.fyi%2Fposts%2Fcpp-character-controller-2%2F&text=Creating%20a%20Character%20Controller%20with%20C++%20(Part%20Two)%20-%20Brooke%20Rhodes" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram" > <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content ps-0 pb-1 ms-1 mt-2"><li> <a href="/posts/one-button-jam-1/">Rust and Bevy Engine: One-Button GameJam (Part One)</a><li> <a href="/posts/one-button-jam-2/">Rust and Bevy Engine: One-Button GameJam (Part Two)</a><li> <a href="/posts/one-button-jam-3/">Rust and Bevy Engine: One-Button GameJam (Part Three)</a><li> <a href="/posts/unity-springs/">Springs for Animation in Unity</a><li> <a href="/posts/playfab-sdk-v3/">PlayFab SDK V3</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/university/">university</a> <a class="post-tag btn btn-outline-primary" href="/tags/gamejam/">gamejam</a> <a class="post-tag btn btn-outline-primary" href="/tags/rust/">rust</a> <a class="post-tag btn btn-outline-primary" href="/tags/c/">c++</a> <a class="post-tag btn btn-outline-primary" href="/tags/unreal-engine/">unreal engine</a> <a class="post-tag btn btn-outline-primary" href="/tags/c/">c#</a> <a class="post-tag btn btn-outline-primary" href="/tags/devlog/">devlog</a> <a class="post-tag btn btn-outline-primary" href="/tags/library/">library</a> <a class="post-tag btn btn-outline-primary" href="/tags/luau/">luau</a> <a class="post-tag btn btn-outline-primary" href="/tags/roblox/">roblox</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/posts/cpp-character-controller-1/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1681254000" data-df="ll" > Apr 12, 2023 </em><h4 class="pt-0 my-2" data-toc-skip>Creating a Character Controller with C++ (Part One)</h4><div class="text-muted small"><p> Over the past month or so, as part of a larger group assignment, I used C++ and Unreal Engine in a real-world project for the first time. The group assignment was to create a networked dodgeball ga...</p></div></div></a></div><div class="col"> <a href="/posts/one-button-jam-1/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1674172800" data-df="ll" > Jan 20, 2023 </em><h4 class="pt-0 my-2" data-toc-skip>Rust and Bevy Engine: One-Button GameJam (Part One)</h4><div class="text-muted small"><p> A few months ago, I completed my first university game jam. Everybody was in teams of two to three, and the only rule was that the game could only use one button. Simple enough! While there was on...</p></div></div></a></div><div class="col"> <a href="/posts/one-button-jam-2/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1674691200" data-df="ll" > Jan 26, 2023 </em><h4 class="pt-0 my-2" data-toc-skip>Rust and Bevy Engine: One-Button GameJam (Part Two)</h4><div class="text-muted small"><p> Given that we only had two weeks to complete this game jam, our group’s concept had to be simple to execute. After exploring various ideas, we ultimately chose a minigolf-style game that used only ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/cpp-character-controller-1/" class="btn btn-outline-primary" prompt="Older" ><p>Creating a Character Controller with C++ (Part One)</p></a><div class="btn btn-outline-primary disabled" prompt="Newer" ><p>-</p></div></div><script type="text/javascript"> (function () { const origin = 'https://giscus.app'; const iframe = 'iframe.giscus-frame'; const lightTheme = 'light'; const darkTheme = 'dark_dimmed'; let initTheme = lightTheme; const html = document.documentElement; if ( (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') || (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches) ) { initTheme = darkTheme; } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'grilme99/grilme99.github.io', 'data-repo-id': 'R_kgDOHdYWRg', 'data-category': 'General', 'data-category-id': 'DIC_kwDOHdYWRs4CR34D', 'data-mapping': 'pathname', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'top', 'data-lang': 'en', crossorigin: 'anonymous', async: '' }; let giscusScript = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value) ); document.getElementById('tail-wrapper').appendChild(giscusScript); addEventListener('message', (event) => { if ( event.source === window && event.data && event.data.direction === ModeToggle.ID ) { /* global theme mode changed */ const mode = event.data.message; const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme; const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); })(); </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/university/">university</a> <a class="post-tag btn btn-outline-primary" href="/tags/gamejam/">gamejam</a> <a class="post-tag btn btn-outline-primary" href="/tags/rust/">rust</a> <a class="post-tag btn btn-outline-primary" href="/tags/c/">c++</a> <a class="post-tag btn btn-outline-primary" href="/tags/unreal-engine/">unreal engine</a> <a class="post-tag btn btn-outline-primary" href="/tags/c/">c#</a> <a class="post-tag btn btn-outline-primary" href="/tags/devlog/">devlog</a> <a class="post-tag btn btn-outline-primary" href="/tags/library/">library</a> <a class="post-tag btn btn-outline-primary" href="/tags/luau/">luau</a> <a class="post-tag btn btn-outline-primary" href="/tags/roblox/">roblox</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p><p>© 2023 <a href="https://brooke.sh">Brooke Rhodes</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/en.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js,npm/tocbot@4.21.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/unregister.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-X2BTMY1TLL"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-X2BTMY1TLL'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
